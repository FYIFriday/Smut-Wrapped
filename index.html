<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src https://archiveofourown.org; frame-src https://archiveofourown.org; webview-src https://archiveofourown.org;">
  <title>Smut Wrapped</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- App Initialization Loading -->
  <div id="app-loading" class="app-loading">
    <div class="app-loading-content">
      <h1 class="app-loading-title">Smut Wrapped</h1>
      <div class="loading-spinner"></div>
      <p class="app-loading-text">Initializing app...</p>
    </div>
  </div>

  <div id="app">
    <!-- Screen 1: Welcome -->
    <div id="screen-welcome" class="screen active">
      <div class="welcome-content">
        <h1 class="title">Smut Wrapped</h1>
        <p class="year">2025</p>
        <p class="subtitle">Your AO3 Year in Review</p>
        <button id="btn-get-started" class="btn-primary">Get Started</button>
        <footer class="welcome-footer">
          <p>Privacy-first &bull; Open source &bull; Free forever</p>
        </footer>
      </div>
    </div>

    <!-- Screen 2: Login -->
    <div id="screen-login" class="screen">
      <div class="login-container">
        <div class="login-header">
          <h2>Log into AO3</h2>
          <p class="privacy-note">Your password and data stay on your device</p>
        </div>

        <div class="webview-container">
          <div id="webview-loading" class="webview-loading">
            <div class="loading-spinner"></div>
            <p id="webview-loading-message">Loading AO3 login page...</p>
          </div>
          <webview
            id="ao3-webview"
            partition="persist:ao3"
            preload=""
          ></webview>
        </div>

        <div class="login-actions">
          <button id="btn-check-login" class="btn-secondary">Check Login Status</button>
          <button id="btn-start-wrapped" class="btn-primary" disabled>
            I'm Logged In - Start My Wrapped!
          </button>
        </div>

        <p id="login-status" class="status-text"></p>

        <!-- Filtering Options -->
        <div id="filter-options" class="filter-options hidden">
          <h3>Options</h3>

          <div class="filter-group">
            <label for="time-filter">Time Range</label>
            <input type="range" id="time-filter" class="filter-slider" min="0" max="2" step="1" value="1">
            <div class="slider-labels">
              <span class="slider-label">All time</span>
              <span class="slider-label">Last 12 months</span>
              <span class="slider-label">Custom pages</span>
            </div>
            <div id="time-filter-value" class="filter-value">Last 12 months</div>
          </div>

          <div id="page-limit-container" class="filter-group hidden">
            <label for="page-limit">Number of pages to scrape</label>
            <input type="range" id="page-limit" class="filter-slider" min="1" max="50" step="1" value="10">
            <div class="filter-value"><span id="page-limit-value">10</span> pages</div>
          </div>

          <div class="filter-group">
            <label>Data Source</label>
            <div class="source-toggle">
              <label class="toggle-option">
                <input type="checkbox" name="source" value="history" id="source-history" checked>
                <span class="toggle-label">Reading History</span>
              </label>
              <label class="toggle-option">
                <input type="checkbox" name="source" value="bookmarks" id="source-bookmarks" checked>
                <span class="toggle-label">Bookmarks</span>
              </label>
            </div>
          </div>

          <div id="profile-stats" class="profile-stats">
            <!-- Will be populated with profile size and time estimate -->
          </div>
        </div>
      </div>
    </div>

    <!-- Screen 3: Progress -->
    <div id="screen-progress" class="screen">
      <div class="progress-content">
        <h2>Generating Your Wrapped...</h2>

        <div class="progress-bar-container">
          <div id="progress-bar" class="progress-bar"></div>
        </div>

        <p id="progress-percent" class="progress-percent">0%</p>
        <p id="progress-status" class="progress-status">Preparing to fetch your reading history...</p>
        <p id="progress-detail" class="progress-detail"></p>

        <div class="rate-limit-notice">
          <p>This takes a while because we respect AO3's servers</p>
          <p class="small-text">We wait 5 seconds between each request</p>
        </div>

        <div class="privacy-notice">
          <p class="small-text">All scraping happens locally on your device. No data is sent to any server. Nothing is saved to your disk unless you save an image.</p>
        </div>

        <button id="btn-cancel-scrape" class="btn-secondary btn-small">Cancel</button>
      </div>
    </div>

    <!-- Screen 4: Results (Wrapped Slides) -->
    <div id="screen-results" class="screen">
      <!-- Filter Panel -->
      <div id="filter-panel" class="filter-panel">
        <button id="btn-toggle-filters" class="btn-filter-toggle">
          <span>⚙️ Filters</span>
        </button>
        <div id="filter-content" class="filter-content">
          <h3>Filter Your Stats</h3>

          <div class="filter-group">
            <label for="word-count-min">Word Count Range</label>
            <div class="slider-container">
              <input type="range" id="word-count-min" min="0" max="200000" step="1000" value="0">
              <input type="range" id="word-count-max" min="0" max="200000" step="1000" value="200000">
            </div>
            <div class="slider-values">
              <span id="word-count-min-value">0</span> - <span id="word-count-max-value">200K+</span> words
            </div>
          </div>

          <div class="filter-group">
            <label>Ratings</label>
            <div class="rating-checkboxes">
              <label class="checkbox-label">
                <input type="checkbox" class="rating-filter" value="Explicit" checked>
                <span>Explicit</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" class="rating-filter" value="Mature" checked>
                <span>Mature</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" class="rating-filter" value="Teen And Up Audiences" checked>
                <span>Teen</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" class="rating-filter" value="General Audiences" checked>
                <span>General</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" class="rating-filter" value="Not Rated" checked>
                <span>Not Rated</span>
              </label>
            </div>
          </div>

          <div class="filter-actions">
            <button id="btn-apply-filters" class="btn-primary btn-small">Apply Filters</button>
            <button id="btn-reset-filters" class="btn-secondary btn-small">Reset</button>
          </div>
        </div>
      </div>

      <div id="slides-container" class="slides-container">
        <!-- Slides will be dynamically generated here -->
      </div>

      <div class="slide-navigation">
        <button id="btn-prev-slide" class="nav-btn" disabled>&larr;</button>
        <span id="slide-counter">1 / 1</span>
        <button id="btn-next-slide" class="nav-btn">&rarr;</button>
      </div>

      <div class="results-actions">
        <button id="btn-download-slide" class="btn-primary">Download This Slide</button>
        <button id="btn-download-all" class="btn-secondary">Download All Slides</button>
        <button id="btn-start-over" class="btn-text">Start Over</button>
      </div>

      <p class="download-warning">Downloaded images may include your AO3 username, ships, and tags. Only save or share where you're comfortable.</p>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="error-title">Error</h3>
        <p id="error-message"></p>
        <div class="modal-actions">
          <button id="btn-error-retry" class="btn-primary">Retry</button>
          <button id="btn-error-close" class="btn-secondary">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="scraper.js"></script>
  <script src="analyzer.js"></script>
  <script src="visualizer.js"></script>
  <script src="app.js"></script>
</body>
</html>
